"use strict";(()=>{var e={};e.id=172,e.ids=[172],e.modules={7096:e=>{e.exports=require("bcrypt")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},7790:e=>{e.exports=require("assert")},4770:e=>{e.exports=require("crypto")},7702:e=>{e.exports=require("events")},2048:e=>{e.exports=require("fs")},2615:e=>{e.exports=require("http")},8791:e=>{e.exports=require("https")},9801:e=>{e.exports=require("os")},5315:e=>{e.exports=require("path")},6162:e=>{e.exports=require("stream")},4175:e=>{e.exports=require("tty")},7360:e=>{e.exports=require("url")},1764:e=>{e.exports=require("util")},1568:e=>{e.exports=require("zlib")},6820:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>I,patchFetch:()=>M,requestAsyncStorage:()=>A,routeModule:()=>h,serverHooks:()=>E,staticGenerationAsyncStorage:()=>x});var s={};t.r(s),t.d(s,{POST:()=>_});var o=t(9303),a=t(8716),i=t(670),n=t(6596),p=t(2291),u=t.n(p),l=t(9406),d=t(7096),m=t.n(d),c=t(7070);async function _(e){try{let r=[];process.env.SUPABASE_SERVICE_ROLE_KEY||r.push("SUPABASE_SERVICE_ROLE_KEY"),process.env.MAILGUN_API_KEY||r.push("MAILGUN_API_KEY"),process.env.MAILGUN_DOMAIN||r.push("MAILGUN_DOMAIN");let t=process.env.MAILGUN_SENDER_EMAIL||process.env.MAIL_FROM_ADDRESS;if(t||r.push("MAILGUN_SENDER_EMAIL or MAIL_FROM_ADDRESS"),r.length>0){let e=`Missing required environment variables: ${r.join(", ")}`;return console.error(e),c.NextResponse.json({error:e},{status:500})}let s=(0,n.eI)("https://ckubfbjfjbhuotyfwmac.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY),o=new l.Z(u()),a=process.env.MAILGUN_ENDPOINT||"https://api.mailgun.net",i=/^https?:\/\//i.test(a)?a:`https://${a}`,p=o.client({username:"api",key:process.env.MAILGUN_API_KEY,url:i}),{email:d,firstName:_,lastName:h,role_id:A,department_ids:x,location_id:E}=await e.json();if(!d||!A)return c.NextResponse.json({error:"Email and Role ID are required."},{status:400});let I=Math.random().toString(36).slice(-8)+Math.random().toString(36).slice(-4)+"!",{data:M,error:y}=await s.auth.admin.createUser({email:d,password:I,email_confirm:!0,user_metadata:{first_name:_,last_name:h}});if(y)return c.NextResponse.json({error:y.message},{status:400});let{error:g}=await s.from("employees").insert({id:M.user.id,email:d,full_name:`${_} ${h}`,role_id:A,location_id:E||null,is_temporary_password:!0,two_factor_enabled:!1});if(g)return await s.auth.admin.deleteUser(M.user.id),c.NextResponse.json({error:g.message},{status:500});try{let e=await m().hash(I,12);await s.from("password_history").insert({employee_id:M.user.id,password_hash:e})}catch(e){console.error("Failed to write initial password history:",e)}if(x&&x.length>0){let e=x.map(e=>({employee_id:M.user.id,department_id:e})),{error:r}=await s.from("employee_departments").insert(e);r&&console.error("Failed to link departments:",r)}try{let e=(process.env.MAILGUN_DOMAIN||"").replace(/^https?:\/\//,"").replace(/\/$/,"");if(!e)throw Error("Missing or invalid MAILGUN_DOMAIN");await p.messages.create(e,{from:`${t}`,to:d,subject:"Welcome to IMS - Your Login Details",text:`Hello ${_},

Your account has been created.

Username: ${d}
Temporary Password: ${I}

Please log in immediately to change your password.

Login here: https://ims.piyamtravel.com`})}catch(e){return console.error("Mailgun send error:",e),c.NextResponse.json({error:`Failed to send onboarding email: ${e.message||e}`},{status:502})}return c.NextResponse.json({success:!0,message:"User created"},{status:200})}catch(e){return console.error("API Error:",e),c.NextResponse.json({error:e.message},{status:500})}}let h=new o.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/admin/add-employee/route",pathname:"/api/admin/add-employee",filename:"route",bundlePath:"app/api/admin/add-employee/route"},resolvedPagePath:"/workspaces/pt-portal/app/api/admin/add-employee/route.js",nextConfigOutput:"",userland:s}),{requestAsyncStorage:A,staticGenerationAsyncStorage:x,serverHooks:E}=h,I="/api/admin/add-employee/route";function M(){return(0,i.patchFetch)({serverHooks:E,staticGenerationAsyncStorage:x})}}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[276,689,972,989],()=>t(6820));module.exports=s})();