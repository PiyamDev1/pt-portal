"use strict";(()=>{var e={};e.id=682,e.ids=[682],e.modules={7096:e=>{e.exports=require("bcrypt")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},7790:e=>{e.exports=require("assert")},4770:e=>{e.exports=require("crypto")},7702:e=>{e.exports=require("events")},2048:e=>{e.exports=require("fs")},2615:e=>{e.exports=require("http")},8791:e=>{e.exports=require("https")},9801:e=>{e.exports=require("os")},5315:e=>{e.exports=require("path")},6162:e=>{e.exports=require("stream")},4175:e=>{e.exports=require("tty")},7360:e=>{e.exports=require("url")},1764:e=>{e.exports=require("util")},1568:e=>{e.exports=require("zlib")},3253:(e,r,s)=>{s.r(r),s.d(r,{originalPathname:()=>I,patchFetch:()=>M,requestAsyncStorage:()=>g,routeModule:()=>A,serverHooks:()=>N,staticGenerationAsyncStorage:()=>E});var t={};s.r(t),s.d(t,{POST:()=>x});var o=s(9303),a=s(8716),i=s(670),n=s(6596),p=s(2291),d=s.n(p),l=s(9406),u=s(7070),m=s(7096),c=s.n(m);let h=(0,n.eI)("https://ckubfbjfjbhuotyfwmac.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY),w=new l.Z(d()),_=process.env.MAILGUN_ENDPOINT||"https://api.mailgun.net",y=/^https?:\/\//i.test(_)?_:`https://${_}`,f=w.client({username:"api",key:process.env.MAILGUN_API_KEY,url:y});async function x(e){try{let r=[];process.env.SUPABASE_SERVICE_ROLE_KEY||r.push("SUPABASE_SERVICE_ROLE_KEY"),process.env.MAILGUN_API_KEY||r.push("MAILGUN_API_KEY"),process.env.MAILGUN_DOMAIN||r.push("MAILGUN_DOMAIN");let s=process.env.MAILGUN_SENDER_EMAIL||process.env.MAIL_FROM_ADDRESS;if(s||r.push("MAILGUN_SENDER_EMAIL or MAIL_FROM_ADDRESS"),r.length>0){let e=`Missing required environment variables: ${r.join(", ")}`;return console.error(e),u.NextResponse.json({error:e},{status:500})}let{employee_id:t,email:o}=await e.json();if(!t&&!o)return u.NextResponse.json({error:"employee_id or email is required"},{status:400});let a=t;if(!a&&o){let{data:e,error:r}=await h.from("employees").select("id").eq("email",o).maybeSingle();if(r)return console.error("Failed to lookup employee by email:",r),u.NextResponse.json({error:r.message},{status:500});if(!e||!e.id)return u.NextResponse.json({error:"No employee found for that email"},{status:404});a=e.id}let i=Math.random().toString(36).slice(-8)+Math.random().toString(36).slice(-4)+"!";try{let{data:e}=await h.from("password_history").select("password_hash").eq("employee_id",a).order("created_at",{ascending:!1}).limit(5);if(e&&e.length>0){for(let r of e)if(await c().compare(i,r.password_hash))return u.NextResponse.json({error:"Temporary password conflicts with recent password history"},{status:400})}}catch(e){console.error("Password history check failed:",e)}try{let{data:e,error:r}=await h.auth.admin.updateUserById(a,{password:i});if(r)return console.error("Failed to update user password:",r),u.NextResponse.json({error:r.message},{status:500})}catch(e){return console.error("Unexpected error updating password:",e),u.NextResponse.json({error:e.message||e},{status:500})}try{await h.from("employees").update({is_temporary_password:!0}).eq("id",a)}catch(e){console.error("Failed to mark employee temp password:",e)}try{let e=await c().hash(i,12);await h.from("password_history").insert({employee_id:a,password_hash:e});let{data:r}=await h.from("password_history").select("id").eq("employee_id",a).order("created_at",{ascending:!1}).limit(5),s=(r||[]).map(e=>e.id).filter(Boolean);s.length>0&&await h.from("password_history").delete().eq("employee_id",a).not("id","in",`(${s.join(",")})`)}catch(e){console.error("Failed to write password history:",e)}let n=o;if(!n){let{data:e}=await h.from("employees").select("email, full_name").eq("id",a).maybeSingle();e&&e.email&&(n=e.email)}if(!n)return u.NextResponse.json({error:"Could not determine email for employee"},{status:500});try{let e=(process.env.MAILGUN_DOMAIN||"").replace(/^https?:\/\//,"").replace(/\/$/,"");if(!e)throw Error("Missing or invalid MAILGUN_DOMAIN");await f.messages.create(e,{from:`${s}`,to:n,subject:"IMS - Password Reset by Admin",text:`Hello,

Your password has been reset by an administrator.

Username: ${n}
Temporary Password: ${i}

Please log in and change your password immediately.

Login here: https://ims.piyamtravel.com`})}catch(e){return console.error("Mailgun send error:",e),u.NextResponse.json({error:`Failed to send email: ${e.message||e}`},{status:502})}return u.NextResponse.json({success:!0,message:"Password reset and emailed"},{status:200})}catch(e){return console.error("Reset API Error:",e),u.NextResponse.json({error:e.message||e},{status:500})}}let A=new o.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/admin/reset-password/route",pathname:"/api/admin/reset-password",filename:"route",bundlePath:"app/api/admin/reset-password/route"},resolvedPagePath:"/workspaces/pt-portal/app/api/admin/reset-password/route.js",nextConfigOutput:"",userland:t}),{requestAsyncStorage:g,staticGenerationAsyncStorage:E,serverHooks:N}=A,I="/api/admin/reset-password/route";function M(){return(0,i.patchFetch)({serverHooks:N,staticGenerationAsyncStorage:E})}}};var r=require("../../../../webpack-runtime.js");r.C(e);var s=e=>r(r.s=e),t=r.X(0,[276,689,972,989],()=>s(3253));module.exports=t})();